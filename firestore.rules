rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user is document owner
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is participant in chat
    function isParticipant(participants) {
      return isSignedIn() && request.auth.uid in participants;
    }
    
    // Helper function to check if user is admin in group
    function isAdmin(admins) {
      return isSignedIn() && request.auth.uid in admins;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isSignedIn();
      
      // Only user can write their own document
      allow write: if isOwner(userId);
    }
    
    // Chats collection
    match /chats/{chatId} {
      // Can read if user is participant
      allow read: if isParticipant(resource.data.participants);
      
      // Can create if user is in the participants list
      allow create: if isSignedIn() 
                    && request.auth.uid in request.resource.data.participants;
      
      // Can update if user is participant
      // For groups, admin-only operations enforced in client
      allow update: if isParticipant(resource.data.participants);
      
      // Can delete if user is participant (for leaving groups)
      allow delete: if isParticipant(resource.data.participants);
      
      // Messages subcollection
      match /messages/{messageId} {
        // Can read messages if user is participant in parent chat
        allow read: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        
        // Can create message if:
        // 1. User is participant in parent chat
        // 2. User is the sender of the message
        allow create: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants)
                      && request.auth.uid == request.resource.data.senderId;
        
        // Can update message if user is participant (for delivery/read receipts)
        allow update: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        
        // No one can delete messages (for now)
        allow delete: if false;
      }
    }
    
    // Action Items collection
    match /actionItems/{itemId} {
      // Can read if user owns the action item
      allow read: if isOwner(resource.data.userId);
      
      // Can create if user is creating for themselves
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      
      // Can update if user owns the action item
      allow update: if isOwner(resource.data.userId);
      
      // Can delete if user owns the action item
      allow delete: if isOwner(resource.data.userId);
    }
  }
}




